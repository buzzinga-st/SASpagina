<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Clasificador SAS</title>
<style>
  /* DiseÃ±o original (colores y forma mantenidos) */
  body { background:#7FFFD4; color:#004d40; font-family:Arial,sans-serif; margin:0; padding:0; }
  .contenedor { text-align:center; margin:40px auto; padding:30px; width:80%; max-width:900px; background:#e0f2f1; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.1); }
  input[type=text], input[type=password], input[type=email] { width:90%; padding:10px; margin:10px 0; border:1px solid #004d40; border-radius:5px; font-size:16px; }
  button { padding:10px 20px; margin:10px; background:#004d40; color:white; border:none; border-radius:5px; cursor:pointer; transition:0.25s; }
  button:hover { background:#00695c; }
  .agregar { background:#00796b; } .agregar:hover { background:#009688; }
  .volver { background:#009688; }
  .mensaje { color:red; font-weight:bold; margin-top:8px; min-height:18px; }
  h1, h2 { text-align:center; margin:6px 0 12px 0; }
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th, td { border:1px solid #004d40; padding:8px; text-align:center; }
  th { background:#004d40; color:#fff; }
  ul { list-style:none; padding:0; margin:0; }
  li { background:#b2dfdb; margin:6px 0; padding:8px; border-radius:5px; display:flex; justify-content:space-between; align-items:center; }
  li div.left { display:flex; align-items:center; gap:10px; }
  li img.thumb { width:48px; height:48px; object-fit:cover; border-radius:6px; border:1px solid rgba(0,77,64,0.2); }
  .boton-editar, .boton-guardar, .boton-eliminar { background:#004d40; color:#fff; border:none; border-radius:5px; padding:6px 8px; margin-left:6px; cursor:pointer; transition:0.2s; }
  #logo-sas { position: fixed; top:10px; left:10px; width:80px; height:80px; object-fit:cover; border-radius:6px; z-index:1000; }
  #rolButtons { display:flex; justify-content:center; gap:12px; flex-wrap:wrap; margin:10px 0 0 0; }
  .rolBtn { width:170px; height:70px; display:flex; align-items:center; justify-content:center; font-size:16px; border-radius:8px; background:#004d40; color:#fff; cursor:pointer; }
  .rolBtn:hover { background:#00695c; }
  .camArea { display:flex; flex-direction:column; align-items:center; gap:8px; margin-bottom:10px; }
  video { border-radius:8px; width:300px; max-width:90%; background:#000; }
  #previewImg, #modalPreview, #loginPreview { width:120px; height:120px; object-fit:cover; border-radius:8px; border:1px solid rgba(0,77,64,0.2); display:none; }
  .modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:2000; }
  .modal .panel { background:#fff; padding:16px; border-radius:8px; width:90%; max-width:520px; text-align:center; color:#004d40; }
  .small { font-size:13px; color:#004d40; }
  @media(max-width:480px){
    #logo-sas { width:64px; height:64px; top:6px; left:6px; } .rolBtn { width:45%; font-size:14px; height:60px; } .contenedor { margin:20px 10px; padding:18px; width:auto; }
  }
</style>
</head>
<body>

<!-- small square logo -->
<img src="pepe.png" id="logo-sas" alt="SAS">

<!-- Roles screen -->
<div id="screenRoles" class="contenedor">
  <h1>Elige tu Rol</h1>
  <div id="rolButtons">
    <div class="rolBtn" onclick="selectRole('alumno')">ALUMNO</div>
    <div class="rolBtn" onclick="selectRole('profesor')">PROFESOR</div>
    <div class="rolBtn" onclick="selectRole('preceptor')">PRECEPTOR</div>
    <div class="rolBtn" onclick="selectRole('admin')">ADMINISTRADOR</div>
  </div>
</div>

<!-- Login screen -->
<div id="screenLogin" class="contenedor" style="display:none;">
  <h1>Inicio de SesiÃ³n â€” <span id="loginRoleTitle"></span></h1>
  <input type="text" id="loginUser" placeholder="Usuario"><br>
  <input type="password" id="loginPass" placeholder="ContraseÃ±a"><br>

  <div id="loginCamArea" class="camArea" style="display:none;">
    <video id="loginVideo" autoplay playsinline style="display:none;"></video>
    <img id="loginPreview" alt="Foto login" style="display:none;">
    <div>
      <button id="btnLoginStartCam" onclick="startLoginCamera()">Activar cÃ¡mara</button>
      <button id="btnLoginTake" onclick="takeLoginPhoto()" disabled>Tomar foto</button>
      <button id="btnLoginRetake" onclick="retakeLoginPhoto()" style="display:none;">Rehacer</button>
    </div>
    <div class="small">Foto opcional en login para actualizar tu foto (solo PROFESOR/PRECEPTOR/ADMIN).</div>
  </div>

  <button onclick="doLogin()">Ingresar</button>
  <p class="small">Â¿No tenÃ©s cuenta? <a href="#" onclick="openRegister()">Crear nuevo usuario</a></p>
  <p id="loginMsg" class="mensaje"></p>
  <p><button class="volver" onclick="backToRoles()">Volver</button></p>
</div>

<!-- Register screen -->
<div id="screenRegister" class="contenedor" style="display:none;">
  <h1>Registrar â€” <span id="registerRoleTitle"></span></h1>

  <div class="camArea">
    <video id="registerVideo" autoplay playsinline style="display:none;"></video>
    <img id="previewImg" alt="Foto registro" style="display:none;">
    <div>
      <button id="btnStartCam" onclick="startRegisterCamera()">Activar cÃ¡mara</button>
      <button id="btnTakePhoto" onclick="takeRegisterPhoto()" disabled>Tomar foto</button>
      <button id="btnRetake" onclick="retakeRegisterPhoto()" style="display:none;">Rehacer</button>
    </div>
    <div class="small">Foto obligatoria para PROFESOR/PRECEPTOR/ADMIN. ALUMNO opcional.</div>
  </div>

  <input type="text" id="regName" placeholder="Nombre completo"><br>
  <input type="email" id="regEmail" placeholder="Correo electrÃ³nico"><br>
  <input type="text" id="regUser" placeholder="Nombre de usuario"><br>
  <input type="password" id="regPass" placeholder="ContraseÃ±a"><br>
  <input type="password" id="regPassConfirm" placeholder="Confirmar contraseÃ±a"><br>

  <button onclick="doRegister()">Registrar</button>
  <button class="volver" onclick="closeRegister()">Volver</button>
  <p id="registerMsg" class="mensaje"></p>
</div>

<!-- Panel (after login) -->
<div id="screenPanel" class="contenedor" style="display:none;">
  <h1>Panel â€” <span id="panelRoleTitle"></span></h1>
  <p id="welcomeText"></p>
  <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
    <button onclick="logout()">Cerrar SesiÃ³n</button>
    <button id="btnPrint" onclick="printLists()" style="display:none;">Imprimir Listas</button>
  </div>

  <h2>Profesores</h2>
  <button id="btnAddProfessor" class="agregar" onclick="openAddProfessorModal()">Agregar Profesor</button>
  <ul id="professorList"></ul>

  <h2>Alumnos</h2>
  <ul id="studentList"></ul>

  <h2>Notas</h2>
  <button id="btnAddNote" class="agregar" onclick="addNote()">Agregar Nota</button>
  <table id="notesTable">
    <tr><th>Alumno</th><th>Materia</th><th>Nota</th><th>Acciones</th></tr>
  </table>

  <h2>Asistencias</h2>
  <table id="attendanceTable">
    <tr><th>Alumno</th><th>Presente</th><th>Tarde</th><th>Ausente</th></tr>
  </table>
</div>

<!-- Modal Add Professor (used by preceptor/admin) -->
<div id="modalAddProfessor" class="modal" style="display:none;">
  <div class="panel">
    <h3>Agregar Profesor</h3>
    <div class="camArea">
      <video id="modalVideo" autoplay playsinline style="display:none;"></video>
      <img id="modalPreview" alt="preview" style="display:none;">
      <div>
        <button id="modalStartCam" onclick="startModalCamera()">Activar cÃ¡mara</button>
        <button id="modalTake" onclick="takeModalPhoto()" disabled>Tomar foto</button>
        <button id="modalRetake" onclick="modalRetake()" style="display:none;">Rehacer</button>
      </div>
    </div>
    <input type="text" id="modalProfName" placeholder="Nombre del profesor"><br>
    <div style="margin-top:8px;">
      <button onclick="saveModalProfessor()">Guardar</button>
      <button onclick="closeModalAddProfessor()">Cancelar</button>
    </div>
    <p id="modalMsg" class="mensaje"></p>
  </div>
</div>

<script>
/* =========== Globals =========== */
let currentRole = null;
let loggedUser = null;
let registerStream=null, registerPhoto=null;
let modalStream=null, modalPhoto=null;
let loginStream=null, loginPhoto=null;

/* initialize localStorage stores */
if(!localStorage.getItem('usuarios')) localStorage.setItem('usuarios', JSON.stringify([]));
if(!localStorage.getItem('notas')) localStorage.setItem('notas', JSON.stringify([]));
if(!localStorage.getItem('asistencias')) localStorage.setItem('asistencias', JSON.stringify([]));

/* ====== Utility UI helpers ====== */
function show(id){ document.getElementById(id).style.display='block'; }
function hide(id){ document.getElementById(id).style.display='none'; }
function tempMsg(id, text, t=3000){
  const el = document.getElementById(id);
  el.textContent = text;
  if(text) setTimeout(()=>{ if(el.textContent === text) el.textContent = ''; }, t);
}

/* ====== Select Role ====== */
function selectRole(role){
  currentRole = role;
  hide('screenRoles');
  document.getElementById('loginRoleTitle').textContent = role.toUpperCase();
  document.getElementById('registerRoleTitle').textContent = role.toUpperCase();
  // show camera in login only for prof/preceptor/admin (optional)
  document.getElementById('loginCamArea').style.display = (role==='profesor' || role==='preceptor' || role==='admin') ? 'block' : 'none';
  show('screenLogin');
  document.getElementById('loginUser').value=''; document.getElementById('loginPass').value='';
  tempMsg('loginMsg','');
}

/* ====== Back to roles ====== */
function backToRoles(){
  stopRegisterCamera(); stopModalCamera(); stopLoginCamera();
  hide('screenLogin'); hide('screenRegister'); hide('screenPanel');
  show('screenRoles'); currentRole=null; loggedUser=null;
}

/* ====== Register flow ====== */
function openRegister(){
  hide('screenLogin'); show('screenRegister');
  registerPhoto=null; document.getElementById('previewImg').style.display='none';
  document.getElementById('registerVideo').style.display='none';
  document.getElementById('btnTakePhoto').disabled = true;
  document.getElementById('btnRetake').style.display='none';
  document.getElementById('btnStartCam').style.display='inline-block';
  tempMsg('registerMsg','');
}

function closeRegister(){ stopRegisterCamera(); hide('screenRegister'); show('screenLogin'); }

/* register camera */
async function startRegisterCamera(){
  try{
    const v = document.getElementById('registerVideo');
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' } });
    registerStream = stream; v.srcObject = stream; v.style.display='block';
    document.getElementById('btnTakePhoto').disabled = false; document.getElementById('btnStartCam').style.display='none';
  }catch(e){ console.error(e); tempMsg('registerMsg','No se pudo activar cÃ¡mara. UsÃ¡ HTTPS o localhost.',4000); }
}
function stopRegisterCamera(){ if(registerStream){ registerStream.getTracks().forEach(t=>t.stop()); registerStream=null; } const v=document.getElementById('registerVideo'); if(v){ v.srcObject=null; v.style.display='none'; } }
function takeRegisterPhoto(){
  const v = document.getElementById('registerVideo');
  if(!v || !v.videoWidth){ tempMsg('registerMsg','CÃ¡mara no lista'); return; }
  const canvas = document.createElement('canvas'); canvas.width=v.videoWidth; canvas.height=v.videoHeight;
  canvas.getContext('2d').drawImage(v,0,0,canvas.width,canvas.height);
  registerPhoto = canvas.toDataURL('image/jpeg',0.9);
  document.getElementById('previewImg').src = registerPhoto; document.getElementById('previewImg').style.display='block';
  stopRegisterCamera();
  document.getElementById('btnTakePhoto').disabled=true;
  document.getElementById('btnRetake').style.display='inline-block';
  tempMsg('registerMsg','Foto tomada âœ”',1500);
}
function retakeRegisterPhoto(){ registerPhoto=null; document.getElementById('previewImg').style.display='none'; document.getElementById('btnRetake').style.display='none'; document.getElementById('btnStartCam').style.display='inline-block'; }

/* registration action */
function doRegister(){
  const nombre = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim().toLowerCase();
  const usuario = document.getElementById('regUser').value.trim();
  const pass = document.getElementById('regPass').value;
  const passc = document.getElementById('regPassConfirm').value;
  if(!nombre || !email || !usuario || !pass || !passc){ tempMsg('registerMsg','Completar todos los campos',3000); return; }
  if(pass !== passc){ tempMsg('registerMsg','Las contraseÃ±as no coinciden',3000); return; }
  // photo required for prof/preceptor/admin
  const photoRequired = (currentRole==='profesor' || currentRole==='preceptor' || currentRole==='admin');
  if(photoRequired && !registerPhoto){ tempMsg('registerMsg','Debes tomar la foto antes de registrarte',3000); return; }
  const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
  // email must be unique globally
  if(usuarios.some(u=>u.email === email && email !== '')){ tempMsg('registerMsg','Ese correo ya estÃ¡ registrado',3000); return; }
  // username unique within role
  if(usuarios.some(u=>u.usuario === usuario && u.rol === currentRole)){ tempMsg('registerMsg','Ese nombre de usuario ya existe en este rol',3000); return; }
  const newUser = { nombre, email, usuario, password:pass, rol: currentRole, foto: registerPhoto || '' };
  usuarios.push(newUser); localStorage.setItem('usuarios', JSON.stringify(usuarios));
  tempMsg('registerMsg','Registro exitoso',1800);
  setTimeout(()=>{ document.getElementById('regName').value=''; document.getElementById('regEmail').value=''; document.getElementById('regUser').value=''; document.getElementById('regPass').value=''; document.getElementById('regPassConfirm').value=''; registerPhoto=null; document.getElementById('previewImg').style.display='none'; closeRegister(); },800);
}

/* ===== Login camera (optional update photo) ===== */
async function startLoginCamera(){
  try{
    const v = document.getElementById('loginVideo');
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' } });
    loginStream = stream; v.srcObject = stream; v.style.display='block';
    document.getElementById('btnLoginTake').disabled=false; document.getElementById('btnLoginStartCam').style.display='none';
  }catch(e){ console.error(e); tempMsg('loginMsg','No se pudo activar la cÃ¡mara',3000); }
}
function stopLoginCamera(){ if(loginStream){ loginStream.getTracks().forEach(t=>t.stop()); loginStream=null; } const v=document.getElementById('loginVideo'); if(v){ v.srcObject=null; v.style.display='none'; } }
function takeLoginPhoto(){
  const v = document.getElementById('loginVideo');
  if(!v || !v.videoWidth){ tempMsg('loginMsg','CÃ¡mara no lista'); return; }
  const canvas = document.createElement('canvas'); canvas.width=v.videoWidth; canvas.height=v.videoHeight;
  canvas.getContext('2d').drawImage(v,0,0,canvas.width,canvas.height);
  loginPhoto = canvas.toDataURL('image/jpeg',0.9);
  document.getElementById('loginPreview').src = loginPhoto; document.getElementById('loginPreview').style.display='block';
  stopLoginCamera();
  document.getElementById('btnLoginTake').disabled=true;
  document.getElementById('btnLoginRetake').style.display='inline-block';
  tempMsg('loginMsg','Foto tomada âœ”',1500);
}
function retakeLoginPhoto(){ loginPhoto=null; document.getElementById('loginPreview').style.display='none'; document.getElementById('btnLoginRetake').style.display='none'; document.getElementById('btnLoginStartCam').style.display='inline-block'; }

/* ===== Login action ===== */
function doLogin(){
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!user || !pass){ tempMsg('loginMsg','Completar usuario y contraseÃ±a',2500); return; }
  const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
  const encontrado = usuarios.find(u => u.usuario === user && u.password === pass && u.rol === currentRole);
  if(!encontrado){ tempMsg('loginMsg','Usuario o contraseÃ±a incorrectos',3000); return; }
  // optionally update foto at login
  if((currentRole==='profesor' || currentRole==='preceptor' || currentRole==='admin') && loginPhoto){
    encontrado.foto = loginPhoto;
    localStorage.setItem('usuarios', JSON.stringify(usuarios));
  }
  loggedUser = encontrado;
  hide('screenLogin'); show('screenPanel');
  document.getElementById('panelRoleTitle').textContent = currentRole.toUpperCase();
  document.getElementById('welcomeText').textContent = `Bienvenido, ${loggedUser.nombre} ðŸ‘‹`;
  // voice welcome (latin american try)
  speak(`Bienvenido al Clasificador SAS, ${loggedUser.nombre}`);
  // cleanup
  stopLoginCamera(); loginPhoto=null; document.getElementById('loginPreview').style.display='none';
  renderAll();
}

/* ===== Logout ===== */
function logout(){
  speak('Gracias por usarnos, vuelve pronto');
  loggedUser=null; stopModalCamera(); stopRegisterCamera(); stopLoginCamera();
  hide('screenPanel'); show('screenRoles'); currentRole=null;
}

/* ===== Render functions ===== */
function renderAll(){
  renderProfessors();
  renderStudents();
  renderNotes();
  renderAttendance();
  // controls visibility by role
  document.getElementById('btnAddProfessor').style.display = (currentRole==='preceptor' || currentRole==='admin') ? 'inline-block' : 'none';
  document.getElementById('btnAddNote').style.display = (currentRole==='alumno') ? 'none' : 'inline-block';
  document.getElementById('btnPrint').style.display = (currentRole==='profesor' || currentRole==='preceptor' || currentRole==='admin') ? 'inline-block' : 'none';
}

/* Professors list - only show users with rol 'profesor' */
function renderProfessors(){
  const container = document.getElementById('professorList'); container.innerHTML='';
  const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
  const profs = usuarios.filter(u=>u.rol==='profesor');
  profs.forEach(p=>{
    const li = document.createElement('li');
    const left = document.createElement('div'); left.className='left';
    const img = document.createElement('img'); img.className='thumb'; img.src = p.foto || placeholderImage();
    left.appendChild(img);
    const span = document.createElement('span'); span.textContent = p.nombre; left.appendChild(span);
    li.appendChild(left);
    const actions = document.createElement('div');
    // edit allowed for preceptor & admin (can't edit photo here)
    if(currentRole==='preceptor' || currentRole==='admin'){
      const btnEdit = document.createElement('button'); btnEdit.className='boton-editar'; btnEdit.textContent='Editar';
      btnEdit.onclick = ()=> editUserName(p.usuario);
      actions.appendChild(btnEdit);
    }
    if(currentRole==='admin'){
      const btnDel = document.createElement('button'); btnDel.className='boton-eliminar'; btnDel.textContent='X';
      btnDel.onclick = ()=>{ if(confirm('Eliminar '+p.nombre+'?')){ deleteUser(p.usuario); renderAll(); } };
      actions.appendChild(btnDel);
    }
    li.appendChild(actions);
    container.appendChild(li);
  });
}

/* Students list */
function renderStudents(){
  const container = document.getElementById('studentList'); container.innerHTML='';
  const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
  const studs = usuarios.filter(u=>u.rol==='alumno');
  studs.forEach(s=>{
    const li = document.createElement('li');
    const left = document.createElement('div'); left.className='left';
    const img = document.createElement('img'); img.className='thumb'; img.src = s.foto || placeholderImage();
    left.appendChild(img);
    const span = document.createElement('span'); span.textContent = s.nombre; left.appendChild(span);
    li.appendChild(left);
    const actions = document.createElement('div');
    // preceptor & admin can edit students
    if(currentRole==='preceptor' || currentRole==='admin'){
      const btnEdit = document.createElement('button'); btnEdit.className='boton-editar'; btnEdit.textContent='Editar';
      btnEdit.onclick = ()=> editUserName(s.usuario);
      actions.appendChild(btnEdit);
    }
    if(currentRole==='admin'){
      const btnDel = document.createElement('button'); btnDel.className='boton-eliminar'; btnDel.textContent='X';
      btnDel.onclick = ()=>{ if(confirm('Eliminar '+s.nombre+'?')){ deleteUser(s.usuario); renderAll(); } };
      actions.appendChild(btnDel);
    }
    li.appendChild(actions);
    container.appendChild(li);
  });
}

/* Edit user name prompt (preceptor/admin can edit) */
function editUserName(usuarioKey){
  const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
  const user = usuarios.find(u=>u.usuario===usuarioKey);
  if(!user) return;
  const nuevo = prompt('Nuevo nombre para ' + user.nombre, user.nombre);
  if(nuevo && nuevo.trim()){ user.nombre = nuevo.trim(); localStorage.setItem('usuarios', JSON.stringify(usuarios)); renderAll(); }
}
function deleteUser(usuarioKey){
  let usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
  usuarios = usuarios.filter(u=>u.usuario!==usuarioKey);
  localStorage.setItem('usuarios', JSON.stringify(usuarios));
}

/* ===== Notes functions ===== */
function renderNotes(){
  const table = document.getElementById('notesTable');
  table.querySelectorAll('tr:not(:first-child)').forEach(r=>r.remove());
  const notas = JSON.parse(localStorage.getItem('notas')) || [];
  notas.forEach((n, idx) => {
    const tr = document.createElement('tr');
    const canEdit = (currentRole==='profesor' || currentRole==='preceptor' || currentRole==='admin');
    tr.innerHTML = `<td contenteditable="${canEdit}">${n.alumno}</td><td contenteditable="${canEdit}">${n.materia}</td><td contenteditable="${canEdit}">${n.nota}</td><td>${canEdit?'<button class="boton-eliminar">Eliminar</button>':''}</td>`;
    table.appendChild(tr);
  });
  attachNoteEvents();
}
function addNote(){ const notas = JSON.parse(localStorage.getItem('notas')) || []; notas.push({ alumno:'Nuevo Alumno', materia:'Materia', nota:'0' }); localStorage.setItem('notas', JSON.stringify(notas)); renderNotes(); }
function attachNoteEvents(){ document.querySelectorAll('#notesTable td[contenteditable]').forEach(td=>td.oninput = saveNotesToStorage); document.querySelectorAll('#notesTable .boton-eliminar').forEach(btn=>btn.onclick=function(){ this.closest('tr').remove(); saveNotesToStorage(); }); }
function saveNotesToStorage(){ const filas = document.querySelectorAll('#notesTable tr:not(:first-child)'); const datos=[]; filas.forEach(f=>{ const c=f.querySelectorAll('td'); if(c.length>=3) datos.push({ alumno: c[0].textContent.trim(), materia: c[1].textContent.trim(), nota: c[2].textContent.trim() }); }); localStorage.setItem('notas', JSON.stringify(datos)); }

/* ===== Attendance ===== */
function renderAttendance(){
  const table = document.getElementById('attendanceTable');
  table.querySelectorAll('tr:not(:first-child)').forEach(r=>r.remove());
  const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
  const alumnos = usuarios.filter(u=>u.rol==='alumno');
  const asistencias = JSON.parse(localStorage.getItem('asistencias')) || [];
  const today = new Date().toISOString().slice(0,10);
  alumnos.forEach(a=>{
    const tr = document.createElement('tr');
    const existing = asistencias.find(x=>x.dia===today && x.alumno===a.usuario);
    const estado = existing ? existing.estado : '';
    const botonesEnabled = (currentRole==='preceptor' || currentRole==='admin' || currentRole==='profesor');
    const btnPres = `<button ${botonesEnabled? '':'disabled'} onclick="markAttendance('${a.usuario}','Presente', this)">${estado==='Presente' ? 'âœ” Presente' : 'Presente'}</button>`;
    const btnTar  = `<button ${botonesEnabled? '':'disabled'} onclick="markAttendance('${a.usuario}','Tarde', this)">${estado==='Tarde' ? 'âœ” Tarde' : 'Tarde'}</button>`;
    const btnAuz  = `<button ${botonesEnabled? '':'disabled'} onclick="markAttendance('${a.usuario}','Ausente', this)">${estado==='Ausente' ? 'âœ” Ausente' : 'Ausente'}</button>`;
    tr.innerHTML = `<td>${a.nombre}</td><td>${btnPres}</td><td>${btnTar}</td><td>${btnAuz}</td>`;
    table.appendChild(tr);
    if(estado){ const btns = tr.querySelectorAll('button'); btns.forEach(b=>{ if(b.textContent.includes(estado.replace('âœ” ',''))) b.style.background='#00796b'; }); }
  });
}
function markAttendance(alumnoUsuario, estado, btnElem){
  if(!(currentRole==='preceptor' || currentRole==='admin' || currentRole==='profesor')) return;
  const asistencias = JSON.parse(localStorage.getItem('asistencias')) || [];
  const dia = new Date().toISOString().slice(0,10);
  const rest = asistencias.filter(a=> !(a.dia===dia && a.alumno===alumnoUsuario));
  rest.push({ dia, alumno: alumnoUsuario, estado, marcadoPor: loggedUser ? loggedUser.usuario : 'anon' });
  localStorage.setItem('asistencias', JSON.stringify(rest));
  // visual update
  const row = btnElem.closest('tr'); row.querySelectorAll('button').forEach(b=>b.style.background=''); btnElem.style.background='#00796b';
}

/* ===== Modal Add Professor (preceptor/admin) ===== */
function openAddProfessorModal(){
  if(!(currentRole==='preceptor' || currentRole==='admin')) return;
  document.getElementById('modalMsg').textContent=''; document.getElementById('modalProfName').value='';
  modalPhoto=null; document.getElementById('modalPreview').style.display='none'; document.getElementById('modalVideo').style.display='none';
  document.getElementById('modalStartCam').style.display='inline-block'; document.getElementById('modalTake').disabled=true; document.getElementById('modalRetake').style.display='none';
  document.getElementById('modalAddProfessor').style.display='flex';
}
async function startModalCamera(){ try{ const v=document.getElementById('modalVideo'); const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' } }); modalStream = stream; v.srcObject = stream; v.style.display='block'; document.getElementById('modalTake').disabled=false; document.getElementById('modalStartCam').style.display='none'; }catch(e){ console.error(e); document.getElementById('modalMsg').textContent='No se pudo acceder a la cÃ¡mara.'; } }
function stopModalCamera(){ if(modalStream){ modalStream.getTracks().forEach(t=>t.stop()); modalStream=null; } const v=document.getElementById('modalVideo'); if(v){ v.srcObject=null; v.style.display='none'; } }
function takeModalPhoto(){ const v=document.getElementById('modalVideo'); if(!v || !v.videoWidth){ document.getElementById('modalMsg').textContent='CÃ¡mara no lista'; return; } const canvas=document.createElement('canvas'); canvas.width=v.videoWidth; canvas.height=v.videoHeight; canvas.getContext('2d').drawImage(v,0,0,canvas.width,canvas.height); modalPhoto = canvas.toDataURL('image/jpeg',0.9); document.getElementById('modalPreview').src = modalPhoto; document.getElementById('modalPreview').style.display='block'; stopModalCamera(); document.getElementById('modalTake').disabled=true; document.getElementById('modalRetake').style.display='inline-block'; }
function modalRetake(){ modalPhoto=null; document.getElementById('modalPreview').style.display='none'; document.getElementById('modalRetake').style.display='none'; document.getElementById('modalStartCam').style.display='inline-block'; document.getElementById('modalTake').disabled=true; }
function closeModalAddProfessor(){ stopModalCamera(); document.getElementById('modalAddProfessor').style.display='none'; }
function saveModalProfessor(){
  const name = document.getElementById('modalProfName').value.trim();
  if(!name){ document.getElementById('modalMsg').textContent='IngresÃ¡ nombre del profesor'; return; }
  if(!modalPhoto){ document.getElementById('modalMsg').textContent='Debes tomar la foto antes de guardar'; return; }
  const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
  // create unique username candidate
  let base = name.toLowerCase().replace(/\s+/g,'').slice(0,10);
  let candidate = base; let i=1;
  while(usuarios.some(u=>u.usuario===candidate && u.rol==='profesor')){ candidate = base + i; i++; }
  const newUser = { nombre: name, email:'', usuario: candidate, password: '1234', rol: 'profesor', foto: modalPhoto };
  usuarios.push(newUser); localStorage.setItem('usuarios', JSON.stringify(usuarios));
  closeModalAddProfessor(); renderAll();
}

/* ===== Printing lists (window.print) ===== */
function printLists(){
  if(!(currentRole==='profesor' || currentRole==='preceptor' || currentRole==='admin')) return;
  const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
  const profs = usuarios.filter(u=>u.rol==='profesor');
  const studs = usuarios.filter(u=>u.rol==='alumno');
  const asistencias = JSON.parse(localStorage.getItem('asistencias')) || [];
  const today = new Date().toLocaleString();
  let html = `<html><head><title>ImpresiÃ³n - Listas</title><style>body{font-family:Arial;color:#004d40}h2{background:#e0f2f1;padding:8px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #004d40;padding:6px;text-align:left}</style></head><body>`;
  html += `<h1>Clasificador SAS â€” Listas</h1><p>Fecha: ${today}</p>`;
  html += `<h2>Profesores</h2><table><tr><th>Nombre</th><th>Usuario</th></tr>`;
  profs.forEach(p=> html += `<tr><td>${escapeHtml(p.nombre)}</td><td>${escapeHtml(p.usuario)}</td></tr>`);
  html += `</table>`;
  html += `<h2>Alumnos</h2><table><tr><th>Nombre</th><th>Usuario</th></tr>`;
  studs.forEach(s=> html += `<tr><td>${escapeHtml(s.nombre)}</td><td>${escapeHtml(s.usuario)}</td></tr>`);
  html += `</table>`;
  html += `<h2>Asistencias (todas)</h2><table><tr><th>DÃ­a</th><th>Alumno (usuario)</th><th>Estado</th><th>Marcado por</th></tr>`;
  asistencias.forEach(a=> html += `<tr><td>${escapeHtml(a.dia)}</td><td>${escapeHtml(a.alumno)}</td><td>${escapeHtml(a.estado)}</td><td>${escapeHtml(a.marcadoPor||'')}</td></tr>`);
  html += `</table></body></html>`;
  const w = window.open('','_blank','noopener');
  w.document.write(html); w.document.close(); w.focus();
  setTimeout(()=> w.print(), 300);
}
function escapeHtml(str){ if(!str) return ''; return str.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ===== speech synthesis (latam prefer) ===== */
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'es-419';
  utter.rate = 1; utter.pitch = 1; utter.volume = 1;
  const voices = speechSynthesis.getVoices();
  let chosen = voices.find(v => v.lang && (v.lang.toLowerCase().includes('es-419') || v.lang.toLowerCase().includes('es-mx') || (v.name && v.name.toLowerCase().includes('spanish') && v.name.toLowerCase().includes('google'))));
  if(!chosen) chosen = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('es'));
  if(chosen) utter.voice = chosen;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}
/* ensure voices available */
window.speechSynthesis.onvoiceschanged = ()=>{ /* no-op */ };

/* ===== placeholders & cleanup ===== */
function placeholderImage(){
  // small inline SVG data URL as neutral placeholder
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='100%' height='100%' fill='%23b2dfdb'/><text x='50%' y='55%' font-size='10' text-anchor='middle' fill='%23004d40' font-family='Arial' dy='.3em'>SAS</text></svg>`);
}

window.addEventListener('beforeunload', ()=>{
  if(registerStream) registerStream.getTracks().forEach(t=>t.stop());
  if(modalStream) modalStream.getTracks().forEach(t=>t.stop());
  if(loginStream) loginStream.getTracks().forEach(t=>t.stop());
});

</script>
</body>
</html>